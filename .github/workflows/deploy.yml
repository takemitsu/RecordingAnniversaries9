name: CI/CD

on:
  pull_request:
    branches: [ develop, main ]
  push:
    branches: [ develop, main ]
  workflow_dispatch:  # æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒˆãƒªã‚¬ãƒ¼

jobs:
  ci:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: ra9_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type Check
        run: npx tsc --noEmit

      - name: Create test env file
        run: |
          cat << EOF > .env.local
          DATABASE_URL="mysql://root:password@127.0.0.1:3306/ra9_test"
          TEST_DATABASE_URL="mysql://root:password@127.0.0.1:3306/ra9_test"
          AUTH_SECRET="test-secret-key-for-ci-must-be-at-least-32-characters-long"
          AUTH_URL="http://localhost:3000"
          GOOGLE_CLIENT_ID="test"
          GOOGLE_CLIENT_SECRET="test"
          NEXT_PUBLIC_WEBAUTHN_RP_ID="localhost"
          NEXT_PUBLIC_WEBAUTHN_RP_NAME="Test"
          NEXT_PUBLIC_WEBAUTHN_ORIGIN="http://localhost:3000"
          NEXT_PUBLIC_APP_NAME="Test"
          NEXT_PUBLIC_APP_URL="http://localhost:3000"
          TZ="Asia/Tokyo"
          NEXT_TELEMETRY_DISABLED=1
          EOF

      - name: Run Tests
        run: npm test

      - name: Build
        run: npm run build

  deploy:
    needs: ci  # CIã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã—ãŸå¾Œã«å®Ÿè¡Œ
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "âŒ Error: VPS_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "âŒ Error: VPS_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "âŒ Error: VPS_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "âŒ Error: DATABASE_URL secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AUTH_SECRET }}" ]; then
            echo "âŒ Error: AUTH_SECRET secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.GOOGLE_CLIENT_ID }}" ]; then
            echo "âŒ Error: GOOGLE_CLIENT_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.GOOGLE_CLIENT_SECRET }}" ]; then
            echo "âŒ Error: GOOGLE_CLIENT_SECRET secret is not set"
            exit 1
          fi
          echo "âœ… All required secrets are set"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22                    # ãƒãƒ¼ãƒˆç•ªå·ã‚’æ˜ç¤º
          timeout: 60s                # SSHæ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ60ç§’ï¼‰
          command_timeout: 10m        # ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ10åˆ†ï¼‰
          script: |
            set -e

            echo "ğŸš€ Starting deployment..."

            # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
            cd ~/RecordingAnniversaries9

            # Gitã‹ã‚‰æœ€æ–°ç‰ˆã‚’å–å¾—
            echo "ğŸ“¦ Pulling latest code..."
            git pull origin main

            # ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ï¼ˆVPSã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãŸã‚devDependencieså«ã‚€ï¼‰
            echo "ğŸ“¦ Installing dependencies..."
            npm ci

            # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
            echo "ğŸ”§ Updating environment variables..."
            cat << EOF > .env.local
            # Database Configuration
            DATABASE_URL="${{ secrets.DATABASE_URL }}"

            # Auth.js Configuration
            AUTH_SECRET="${{ secrets.AUTH_SECRET }}"
            AUTH_URL="https://ra.takemitsu.net"

            # Google OAuth
            GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
            GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"

            # WebAuthn (Passkey) Configuration
            NEXT_PUBLIC_WEBAUTHN_RP_ID="ra.takemitsu.net"
            NEXT_PUBLIC_WEBAUTHN_RP_NAME="Recording Anniversaries"
            NEXT_PUBLIC_WEBAUTHN_ORIGIN="https://ra.takemitsu.net"

            # Application
            NEXT_PUBLIC_APP_NAME="Recording Anniversaries 9"
            NEXT_PUBLIC_APP_URL="https://ra.takemitsu.net"

            # Timezone
            TZ="Asia/Tokyo"

            # Next.js Telemetry
            NEXT_TELEMETRY_DISABLED=1
            EOF
            chmod 600 .env.local

            # ãƒ“ãƒ«ãƒ‰
            echo "ğŸ—ï¸  Building application..."
            npm run build

            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            echo "ğŸ—„ï¸  Running database migrations..."
            npm run db:migrate

            # PM2ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•
            echo "â™»ï¸  Restarting application..."
            pm2 restart ra9-app || pm2 start npm --name "ra9-app" -- start

            # ãƒ­ã‚°ç¢ºèª
            echo "ğŸ“‹ Application logs:"
            pm2 logs ra9-app --lines 20 --nostream

            echo "âœ… Deployment complete!"
